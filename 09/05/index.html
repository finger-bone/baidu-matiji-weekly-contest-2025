<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://finger-bone.github.io/baidu-matiji-weekly-contest-2025/09/05/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>神奇的树 - 百度马蹄集周赛 2025</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/color-brewer.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">百度马蹄集周赛 2025</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../04/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" class="nav-link disabled">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#_1" class="nav-link">神奇的树</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#_2" class="nav-link">题干</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_3" class="nav-link">思路</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_10" class="nav-link">代码</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="_1">神奇的树</h1>
<p>https://www.matiji.net/exam/dohomework/8235/2</p>
<h2 id="_2">题干</h2>
<p>小码哥在花园中种了 <script type="math/tex">n</script> 颗神奇的树，花园中的第 <script type="math/tex">i</script> 颗树 <script type="math/tex">T_i</script> 正好是无根树 <script type="math/tex">G</script> 以 <script type="math/tex">i</script> 节点为根所形成的有根树。（ <script type="math/tex">G</script> 由输入给定）</p>
<p>小码哥想知道对于所有从 <script type="math/tex">1</script> 到 <script type="math/tex">n</script> 的 <script type="math/tex">i</script> ， <script type="math/tex">T_i</script> 与花园中的多少颗树同构，即集合 <script type="math/tex">\{T_j | 1 \leq j \leq n 且 T_j 与 T_i 同构\}</script> 的大小？（ <script type="math/tex">T_i</script> 与 <script type="math/tex">T_j</script> 同构也可统计进答案）</p>
<p>两棵有根树 <script type="math/tex">T_1</script>
<script type="math/tex">T_2</script> 同构当且仅当它们的大小相等，且存在一个顶点排列 <script type="math/tex">\sigma</script> 使得在 <script type="math/tex">T_1</script> 中 <script type="math/tex">i</script> 是 <script type="math/tex">j</script> 的祖先当且仅当在 <script type="math/tex">T_2</script> 中 <script type="math/tex">\sigma(i)</script> 是 <script type="math/tex">\sigma(j)</script> 的祖先。</p>
<h2 id="_3">思路</h2>
<p>注意时间限制 <script type="math/tex">3s</script> 不是 <script type="math/tex">1s</script> ， <script type="math/tex">n \leq 5e5</script> ，大概是 <script type="math/tex">O(n \log n)</script> 以下。</p>
<p>做法是树 hash，即对于一个树，将其编码成 hash。然后计算过程中是可以直接换根的，因此复杂度只有 <script type="math/tex">O(n)</script>。</p>
<h3 id="_4">树哈希的定义与计算方法</h3>
<p>树哈希是一种将树结构编码成一个唯一哈希值的方法，它能够帮助我们快速判断两棵树是否<strong>同构</strong>。在同构的树中，节点的相对结构是相同的，但节点的编号可能不同。</p>
<h3 id="_5">树哈希的核心思想</h3>
<p>我们通过递归地计算每个节点的哈希值 <script type="math/tex">val</script> ，并结合子节点的哈希值来唯一确定一棵树的结构。<br />
树哈希的定义包含以下几点：</p>
<ol>
<li><strong>叶子节点的哈希值</strong>是一个固定值，通常初始化为 <script type="math/tex">c = 1</script>（可以理解为基本单元）。</li>
<li><strong>非叶子节点的哈希值</strong>由其所有子节点的哈希值通过某个函数组合得到。</li>
<li>为了避免哈希冲突，通常使用一个扰动函数 <script type="math/tex">f(x)</script> 对子节点的哈希值进行处理，使哈希值更加均匀分布。</li>
</ol>
<h3 id="_6">具体计算方法</h3>
<p>我们定义一个节点 <script type="math/tex">i</script> 的哈希值 <script type="math/tex">val[i]</script> 如下：</p>
<ul>
<li><strong>基础值</strong> <script type="math/tex">c</script>：每个节点自身初始哈希值设为 1。</li>
<li><strong>扰动函数 <script type="math/tex">f(x)</script></strong>：用于对子节点的哈希值进行扰动，常用形式是：</li>
</ul>
<p>
<script type="math/tex; mode=display">
  f(x) = x \oplus \text{随机数}
  </script>
</p>
<p>其中 <script type="math/tex">\oplus</script> 表示按位异或，或者可以用 <script type="math/tex">x \times 31 + 7</script> 等其他操作。<br />
   这个函数的作用是让相同结构但不同子树排列的节点产生不同的中间哈希值，减少冲突。</p>
<ul>
<li><strong>节点哈希值的计算公式</strong>：<br />
   对于一个节点 <script type="math/tex">i</script>，它的哈希值 <script type="math/tex">val[i]</script> 等于自身基础值 <script type="math/tex">c</script> 加上所有子节点的扰动后哈希值之和：
  <script type="math/tex; mode=display">
  val[i] = c + \sum_{j \in \text{子节点}(i)} f(val[j])
  </script>
  其中 <script type="math/tex">f(val[j])</script> 是子节点 <script type="math/tex">j</script> 的哈希值经过扰动函数处理后的结果。</li>
</ul>
<h3 id="_7">示例</h3>
<p>考虑以下树结构：</p>
<pre><code>       1
      / \
     2   3
    / \
   4   5
</code></pre>
<h4 id="_8">自底向上计算哈希值</h4>
<p><strong>叶子节点（4 和 5）</strong>：  </p>
<p>叶子节点没有子节点，它们的哈希值初始化为 <script type="math/tex">c = 1</script> ， <script type="math/tex">val[4] = 1</script> ， <script type="math/tex">val[5] = 1</script> 。</p>
<p><strong>节点 2</strong>（子节点为 4 和 5）：  </p>
<p>
<script type="math/tex">val[2]</script> 由自身的初始值和两个子节点的哈希值决定：</p>
<p>
<script type="math/tex; mode=display">
val[2] = c + f(val[4]) + f(val[5])
</script>
</p>
<p>假设扰动函数 <script type="math/tex">f(x) = x \times 31 + 7</script> ，则：</p>
<p>
<script type="math/tex; mode=display">
f(1) = 1 \times 31 + 7 = 38
</script>
</p>
<p>所以：</p>
<p>
<script type="math/tex; mode=display">
val[2] = 1 + 38 + 38 = 77
</script>
</p>
<p><strong>节点 3</strong>（叶子节点）：  </p>
<p>
<script type="math/tex">val[3] = c = 1</script> 。</p>
<p><strong>根节点 1</strong>（子节点为 2 和 3）：  </p>
<p>
<script type="math/tex">val[1]</script> 由自身的初始值和两个子节点的哈希值决定：</p>
<p>
<script type="math/tex; mode=display">
val[1] = c + f(val[2]) + f(val[3])
</script>
</p>
<p>已知 <script type="math/tex">val[2] = 77</script> ， <script type="math/tex">val[3] = 1</script> ，并计算：</p>
<p>
<script type="math/tex; mode=display">
f(77) = 77 \times 31 + 7 = 2394, \quad f(1) = 38
</script>
</p>
<p>所以：</p>
<p>
<script type="math/tex; mode=display">
val[1] = 1 + 2394 + 38 = 2433
</script>
</p>
<p><strong>最终的哈希值：</strong></p>
<table>
<thead>
<tr>
<th style="text-align: center;">节点 <script type="math/tex">i</script>
</th>
<th style="text-align: center;">子节点</th>
<th style="text-align: center;">
<script type="math/tex">val[i]</script>
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">4</td>
<td style="text-align: center;">无</td>
<td style="text-align: center;">1</td>
</tr>
<tr>
<td style="text-align: center;">5</td>
<td style="text-align: center;">无</td>
<td style="text-align: center;">1</td>
</tr>
<tr>
<td style="text-align: center;">2</td>
<td style="text-align: center;">4, 5</td>
<td style="text-align: center;">77</td>
</tr>
<tr>
<td style="text-align: center;">3</td>
<td style="text-align: center;">无</td>
<td style="text-align: center;">1</td>
</tr>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: center;">2, 3</td>
<td style="text-align: center;">2433</td>
</tr>
</tbody>
</table>
<p>现在可以计算任意有根树的哈希了，不过下面可以通过换根加速计算。</p>
<h4 id="_9">换根</h4>
<p>因为 <script type="math/tex">hash_0(root_0) = c + \sum_{j \in \text{旧树子节点}(root_0)} f(hash_1(j))</script>
</p>
<p>而如果要换到一个相连的 <script type="math/tex">root_1</script> ，那么 <script type="math/tex">hash_1(root_1) = c + \sum_{j \in \text{新树子节点}(root_1)} f(hash_1(j))</script>
</p>
<p>注意，只有 <script type="math/tex">root_0</script> 和 <script type="math/tex">root_1</script> 的从属关系发生变化，因此其它子树的哈希不变，因此在新的树里， </p>
<p>
<script type="math/tex; mode=display">
hash_1(root_0) = c + \sum_{j \in \text{新树子节点}(root_0)} f(hash_1(j))= hash_0(root_0) - hash_0(root_1)
</script>
</p>
<p>而 <script type="math/tex">hash_1(root_1) = hash_0(root_1) + hash_1(root_0)</script>
</p>
<p>对于其它节点， <script type="math/tex">hash_0(i) = hash_1(i)</script> 。同时，哈希规则不变，因此它总是代表树的结构——如果两个树的结构相同，那么它们的哈希值也相同。</p>
<p>这样程序实际复杂度在 <script type="math/tex">O(n)</script> ，可能常数比较大。</p>
<h2 id="_10">代码</h2>
<p>为了避免 hash 碰撞，把 <script type="math/tex">f</script> 可以任性地取复杂一些。</p>
<pre><code class="language-cpp">#include &lt;vector&gt;
#include &lt;functional&gt;
#include &lt;iostream&gt;
#include &lt;map&gt;

using namespace std;
using ull = unsigned long long;

constexpr ull mask = 0x1234567898765432;

ull f(ull x) {
    x ^= mask;
    x ^= x &lt;&lt; 7;
    x ^= x &gt;&gt; 13;
    x ^= x &lt;&lt; 11;
    x ^= mask;
    return x;
}

int main( )
{
    int n;
    cin &gt;&gt; n;
    vector&lt;vector&lt;int&gt;&gt; next(n, vector&lt;int&gt;());
    for(int i = 0; i &lt; n - 1; ++i) {
        int a, b;
        cin &gt;&gt; a &gt;&gt; b;
        --a;
        --b;
        next[a].push_back(b);
        next[b].push_back(a);
    }
    vector&lt;ull&gt; root_h(n, 0);
    vector&lt;ull&gt; tmp_h(n, 1);
    function&lt;void(int,int)&gt; dfs = [&amp;](int cur, int from) {
        for(int n: next[cur]) {
            if(n != from) dfs(n, cur);
        }
        for(int n: next[cur]) {
            if(n == from) continue;
            tmp_h[cur] += f(tmp_h[n]);
        }
    };
    dfs(0, -1);
    function&lt;void(int,int)&gt; dfs2 = [&amp;](int cur, int from) {
        root_h[cur] = tmp_h[cur];
        for(int n: next[cur]) {
            if(n == from) continue;
            ull next_hash = f(tmp_h[n]);
            tmp_h[cur] -= next_hash;
            tmp_h[n] += tmp_h[cur];
            dfs2(n, cur);
            tmp_h[n] -= tmp_h[cur];
            tmp_h[cur] += next_hash;
        }
    };
    dfs2(0, -1);
    map&lt;ull, int&gt; cnt;
    for(auto e: root_h) {
        ++cnt[e];
    }
    for(auto e: root_h) {
        cout &lt;&lt; cnt[e] &lt;&lt; endl;
    }
    return 0;
}
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/jquery-3.6.0.min.js"></script>
        <script src="../../js/bootstrap.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
